#!/bin/sh

# @todo; これ見直そう。。sudo使うのは分離。実行するかどうかは設定ファイルみて個別で判定したい。

has_cmd() {
    command -v "$1" >/dev/null 2>&1
}

has_sudo() {
    ! sudo -n true 2>&1 | grep -q "Permission denied"
}

if has_cmd gsed; then
    alias sed='gsed'
fi

if has_sudo; then
    echo sudo権限あり
else
    echo sudo権限なし
fi

# gem
if has_sudo && has_cmd gem && has_cmd rbenv; then
    CURRENT_RUBY_VERSION=$(rbenv version-name)
    if [ "$CURRENT_RUBY_VERSION" != "system" ]; then
        echo "# gem"
        sudo gem update --system
        sudo gem update
        sudo gem install bundler xcpretty
    fi
fi

# homebrew
# setup.shでも
if has_cmd brew; then
#if [ -x "`which  brew 2>/dev/null`" ]; then
    echo "# homebrew"
    brew update
    brew upgrade
    brew upgrade --cask
fi

# nodenv
if has_cmd nodenv; then
    echo "# nodenv"
    NODE_VERSION=$(nodenv install -L | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | awk -F. '$1 % 2 == 0' | sort -V | tail -1)
    CURRENT_GLOBAL=$(nodenv global)
    if [ "$NODE_VERSION" != "$CURRENT_GLOBAL" ]; then
        echo "Installing Node.js $NODE_VERSION..."
        nodenv install "$NODE_VERSION"
        nodenv global "$NODE_VERSION"
        nodenv rehash
        echo "Node.js $NODE_VERSION has been installed and set as global"
    else
        echo "Node.js $NODE_VERSION is already global"
    fi
fi

# npm
if has_cmd npm; then
    echo "# npm"
    NODENV_VERSION=$(nodenv global) npm update -g
    nodenv rehash
fi

# # emacs cask
# if [ -x "`which cask 2>/dev/null`" ]; then
#     echo emacs cask
#     cd ~/.emacs.d/ ; cask install ; cd -
# fi

# emacs straight
# caskは一旦使用中止してみる
#rm -rf ~/.emacs.d/straight/ ~/.emacs.d/.cask/
echo "# emacs straight.el"
rm -rf ~/.emacs.d/.cask/
emacs --batch -l ~/.emacs.d/init.el --eval="(progn
             (straight-pull-all)
             (straight-check-all))"

# yum
if has_sudo && has_cmd yum; then
    echo "# yum"
    sudo yum update
fi

# apt
if has_sudo && has_cmd apt-get; then
    echo "# apt"
    sudo apt-get update
    sudo apt-get upgrade
fi

# pear
# pear upgrade-all

# nvm バージョン上げたいとき
# nvm install stable
# nvm alias default stable
# あとは ll .nvm/v*/**//lib/node_modules/ とかで使ってたglobal modulesをインストールする。
# 例) npm install -g bower coffee-script grunt-cli ricoh-theta yslow

# python2.6以上に依存＞cask
# pyenv install 2.7.9
