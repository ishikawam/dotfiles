#!/bin/bash

# è‰²ä»˜ãå‡ºåŠ›ï¼ˆè£…é£¾ï¼‰
info()  { echo -e "\033[1;34m$1\033[0m"; }
warn()  { echo -e "\033[1;33m$1\033[0m"; }
error() { echo -e "\033[1;31m$1\033[0m"; }

# å¼•æ•°ãªã—ãªã‚‰ã‚«ãƒ¬ãƒ³ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
TARGETS=("$@")
if [ ${#TARGETS[@]} -eq 0 ]; then
    TARGETS=(.)
fi

### 1. ãƒ•ã‚¡ã‚¤ãƒ«ç³»ã®ã‚´ãƒŸã¾ã¨ã‚ã¦ç¢ºèª
info "ğŸ” Checking for junk files: .DS_Store, Thumbs.db, .AppleDouble/, __MACOSX/"

JUNK_LIST=()
for TARGET in "${TARGETS[@]}"; do
    if [ -d "$TARGET" ]; then
        JUNK_LIST+=( $(find "$TARGET" \( \
            -name '.DS_Store' -o \
            -name 'Thumbs.db' -o \
            -name '.AppleDouble' -o \
            -name '__MACOSX' \
        \) ) )
    else
        warn "âš ï¸ Skipping: '$TARGET' is not a directory"
    fi
done

if [ ${#JUNK_LIST[@]} -eq 0 ]; then
    info "âœ… No junk files or folders found."
else
    printf "%s\n" "${JUNK_LIST[@]}"
    warn "Delete all these junk files/directories? [y/N]"
    read -r junk_ans
    if [[ "$junk_ans" == "y" ]]; then
        for TARGET in "${TARGETS[@]}"; do
            find "$TARGET" -name '.DS_Store'    -type f -delete
            find "$TARGET" -name 'Thumbs.db'    -type f -delete
            find "$TARGET" -name '.AppleDouble' -type d -exec rm -r {} +
            find "$TARGET" -name '__MACOSX'     -type d -exec rm -r {} +
        done
        info "ğŸ—‘ï¸ Junk files/directories deleted."
    else
        info "â© Skipped junk deletion."
    fi
fi

echo

### 2. ç©ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤ï¼ˆåˆ¥ç¢ºèªï¼‰
info "ğŸ” Checking for empty directories..."

EMPTY_LIST=()
for TARGET in "${TARGETS[@]}"; do
    if [ -d "$TARGET" ]; then
        EMPTY_LIST+=( $(find "$TARGET" -type d -empty) )
    fi
done

if [ ${#EMPTY_LIST[@]} -eq 0 ]; then
    info "âœ… No empty directories found."
else
    printf "%s\n" "${EMPTY_LIST[@]}"
    warn "Delete all these empty directories? [y/N]"
    read -r empty_ans
    if [[ "$empty_ans" == "y" ]]; then
        for TARGET in "${TARGETS[@]}"; do
            find "$TARGET" -type d -empty -delete
        done
        info "ğŸ“ Empty directories deleted."
    else
        info "â© Skipped empty directory deletion."
    fi
fi

info "ğŸ‰ Cleaning finished."
